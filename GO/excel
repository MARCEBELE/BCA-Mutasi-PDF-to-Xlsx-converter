package main

import (
	"fmt"

	"github.com/xuri/excelize/v2"
)

func (p *BCAParser) ExportToExcel(filename string) error {
	f := excelize.NewFile()

	f.SetAppProps(&excelize.AppProperties{
		Application: "BCA Statement Converter",
		Company:     "MARCEBELE",
	})
	f.SetDocProps(&excelize.DocProperties{
		Creator:        "MARCEBELE",
		LastModifiedBy: "MARCEBELE",
	})

	defer func() {
		if err := f.Close(); err != nil {
			fmt.Println(err)
		}
	}()

	f.SetSheetName("Sheet1", "Account Info")
	_, err := f.NewSheet("Transactions")
	if err != nil {
		return err
	}
	_, err = f.NewSheet("Summary")
	if err != nil {
		return err
	}

	if err = p.createAccountInfoSheet(f); err != nil {
		return err
	}
	if err = p.createTransactionsSheet(f); err != nil {
		return err
	}
	if err = p.createSummarySheet(f); err != nil {
		return err
	}

	f.SetActiveSheet(1) // Transactions
	return f.SaveAs(filename)
}

func (p *BCAParser) createAccountInfoSheet(f *excelize.File) error {
	sheet := "Account Info"

	headers := []string{"Account Number", "Period", "Account Holder", "Currency"}
	for i, h := range headers {
		cell, _ := excelize.CoordinatesToCellName(i+1, 1)
		f.SetCellValue(sheet, cell, h)
	}

	data := []interface{}{p.AccountInfo.AccountNumber, p.AccountInfo.Period,
		p.AccountInfo.AccountHolder, p.AccountInfo.Currency}
	for i, v := range data {
		cell, _ := excelize.CoordinatesToCellName(i+1, 2)
		f.SetCellValue(sheet, cell, v)
	}

	headerStyle, _ := f.NewStyle(&excelize.Style{
		Font: &excelize.Font{Bold: true},
		Fill: excelize.Fill{Type: "pattern", Color: []string{"#E0E0E0"}, Pattern: 1},
	})
	for i := range headers {
		cell, _ := excelize.CoordinatesToCellName(i+1, 1)
		f.SetCellStyle(sheet, cell, cell, headerStyle)
	}

	for i := range headers {
		col, _ := excelize.ColumnNumberToName(i + 1)
		f.SetColWidth(sheet, col, col, 20)
	}

	return nil
}

func (p *BCAParser) createTransactionsSheet(f *excelize.File) error {
	sheet := "Transactions"

	headers := []string{"Date", "Description", "Type", "Amount", "Balance"}
	for i, h := range headers {
		cell, _ := excelize.CoordinatesToCellName(i+1, 1)
		f.SetCellValue(sheet, cell, h)
	}

	for i, txn := range p.Transactions {
		row := i + 2
		cell, _ := excelize.CoordinatesToCellName(1, row)
		f.SetCellValue(sheet, cell, txn.Date.Format("2006-01-02"))
		cell, _ = excelize.CoordinatesToCellName(2, row)
		f.SetCellValue(sheet, cell, txn.Description)
		cell, _ = excelize.CoordinatesToCellName(3, row)
		f.SetCellValue(sheet, cell, txn.Type)
		cell, _ = excelize.CoordinatesToCellName(4, row)
		if txn.Amount > 0 {
			f.SetCellValue(sheet, cell, txn.Amount)
		}
		cell, _ = excelize.CoordinatesToCellName(5, row)
		if txn.Balance > 0 {
			f.SetCellValue(sheet, cell, txn.Balance)
		}
	}

	headerStyle, _ := f.NewStyle(&excelize.Style{
		Font:      &excelize.Font{Bold: true, Color: "#FFFFFF"},
		Fill:      excelize.Fill{Type: "pattern", Color: []string{"#4472C4"}, Pattern: 1},
		Alignment: &excelize.Alignment{Horizontal: "center", Vertical: "center"},
	})
	f.SetCellStyle(sheet, "A1", "E1", headerStyle)

	numStyle, _ := f.NewStyle(&excelize.Style{NumFmt: 4}) // #,##0.00
	if len(p.Transactions) > 0 {
		last := len(p.Transactions) + 1
		f.SetCellStyle(sheet, "D2", fmt.Sprintf("D%d", last), numStyle)
		f.SetCellStyle(sheet, "E2", fmt.Sprintf("E%d", last), numStyle)
	}

	f.SetColWidth(sheet, "A", "A", 12) // Date
	f.SetColWidth(sheet, "B", "B", 50) // Description
	f.SetColWidth(sheet, "C", "C", 10) // Type
	f.SetColWidth(sheet, "D", "D", 15) // Amount
	f.SetColWidth(sheet, "E", "E", 15) // Balance

	f.SetPanes(sheet, &excelize.Panes{
		Freeze: true, YSplit: 1, TopLeftCell: "A2", ActivePane: "bottomLeft",
	})

	if len(p.Transactions) > 0 {
		last := len(p.Transactions) + 1
		f.AutoFilter(sheet, fmt.Sprintf("A1:E%d", last), []excelize.AutoFilterOptions{})
	}

	return nil
}

func (p *BCAParser) createSummarySheet(f *excelize.File) error {
	sheet := "Summary"

	headers := []string{"Opening Balance", "Total Credits", "Credit Count",
		"Total Debits", "Debit Count", "Closing Balance"}
	for i, h := range headers {
		cell, _ := excelize.CoordinatesToCellName(i+1, 1)
		f.SetCellValue(sheet, cell, h)
	}

	data := []interface{}{p.Summary.OpeningBalance, p.Summary.TotalCredits,
		p.Summary.CreditCount, p.Summary.TotalDebits,
		p.Summary.DebitCount, p.Summary.ClosingBalance}
	for i, v := range data {
		cell, _ := excelize.CoordinatesToCellName(i+1, 2)
		f.SetCellValue(sheet, cell, v)
	}

	headerStyle, _ := f.NewStyle(&excelize.Style{
		Font:      &excelize.Font{Bold: true, Color: "#FFFFFF"},
		Fill:      excelize.Fill{Type: "pattern", Color: []string{"#70AD47"}, Pattern: 1},
		Alignment: &excelize.Alignment{Horizontal: "center"},
	})
	for i := range headers {
		cell, _ := excelize.CoordinatesToCellName(i+1, 1)
		f.SetCellStyle(sheet, cell, cell, headerStyle)
	}

	numStyle, _ := f.NewStyle(&excelize.Style{NumFmt: 4}) // #,##0.00
	// C and F are counts (integers) â€” skip them.
	f.SetCellStyle(sheet, "A2", "A2", numStyle)
	f.SetCellStyle(sheet, "B2", "B2", numStyle)
	f.SetCellStyle(sheet, "D2", "D2", numStyle)
	f.SetCellStyle(sheet, "F2", "F2", numStyle)

	for i := range headers {
		col, _ := excelize.ColumnNumberToName(i + 1)
		f.SetColWidth(sheet, col, col, 18)
	}

	return nil
}
